from aiogram import Router, Bot, types
from aiogram.filters import CommandStart
from aiogram.types import Message

from config.settings import config, logger
from keyboards.inline import main_menu_keyboard
from utils.smt_texts import welcome_text

router = Router()

# BOT_TOKEN = os.getenv("BOT_TOKEN", "")
# CHANNEL_IDS = [int(ch_id) for ch_id in os.getenv("CHANNEL_IDS", "").split(",") if ch_id.strip().isdigit()]

# if not BOT_TOKEN:
#     raise ValueError("BOT_TOKEN –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ! –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ .env —Ñ–∞–π–ª –º—ñ—Å—Ç–∏—Ç—å BOT_TOKEN")


@router.message(CommandStart())
async def start_cmd(message: Message):
    """–û–±—Ä–æ–±–∫–∞ –∫–æ–º–∞–Ω–¥–∏ /start"""
    await message.answer(
        text=welcome_text,
        reply_markup=main_menu_keyboard(),
        parse_mode="HTML"
    )


async def pin_webapp_menu():
    """–ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –≤–µ–±-–¥–æ–¥–∞—Ç–∫–æ–º —É –∫–∞–Ω–∞–ª—ñ"""
    bot = Bot(token=config.BOT_TOKEN)
    channel_ids = config.CHANNEL_IDS

    for channel_id in channel_ids:
        try:
            msg = await bot.send_message(
                chat_id=channel_id,
                text="üõí –î–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ üëá",
                reply_markup=types.InlineKeyboardMarkup(inline_keyboard=[
                    [types.InlineKeyboardButton(
                        text="üõç –í—ñ–¥–∫—Ä–∏—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥",
                        web_app=types.WebAppInfo(url="https://barskyi.github.io/for_order.html")
                    )]
                ])
            )
            await bot.pin_chat_message(chat_id=channel_id, message_id=msg.message_id)
            logger.info(f"‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑–∞–∫—Ä—ñ–ø–ª–µ–Ω–µ –≤ –∫–∞–Ω–∞–ª—ñ {channel_id}")
        except Exception as e:
            logger.error(f"‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–∫—Ä—ñ–ø–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ {channel_id}: {e}")

    await bot.session.close()


async def on_startup():
    """–§—É–Ω–∫—Ü—ñ—è, —è–∫–∞ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ –±–æ—Ç–∞"""
    await pin_webapp_menu()
